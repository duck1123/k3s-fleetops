apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
  name: postgresql-init-databases
  namespace: postgresql
spec:
  template:
    spec:
      containers:
        - command:
            - sh
            - -c
            - |+
              set -e
              echo "Creating database prowlarr-main and user prowlarr..."
              psql -v ON_ERROR_STOP=1 <<-EOSQL
                -- Create database if it doesn't exist
                SELECT format('CREATE DATABASE %I', 'prowlarr-main') WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'prowlarr-main')\gexec

                -- Create user if it doesn't exist
                DO \$\$
                BEGIN
                  IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'prowlarr') THEN
                    EXECUTE format('CREATE USER %I WITH PASSWORD %L', 'prowlarr', 'omE.6H):+]qedMo>ZG;m');
                  END IF;
                END
                \$\$;

                -- Grant privileges (quote database name)
                DO \$\$
                BEGIN
                  EXECUTE format('GRANT ALL PRIVILEGES ON DATABASE %I TO %I', 'prowlarr-main', 'prowlarr');
                  EXECUTE format('ALTER DATABASE %I OWNER TO %I', 'prowlarr-main', 'prowlarr');
                END
                \$\$;
              EOSQL
              echo "Database prowlarr-main created successfully"

              echo "Creating database prowlarr-log and user prowlarr..."
              psql -v ON_ERROR_STOP=1 <<-EOSQL
                -- Create database if it doesn't exist
                SELECT format('CREATE DATABASE %I', 'prowlarr-log') WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'prowlarr-log')\gexec

                -- Create user if it doesn't exist
                DO \$\$
                BEGIN
                  IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'prowlarr') THEN
                    EXECUTE format('CREATE USER %I WITH PASSWORD %L', 'prowlarr', 'omE.6H):+]qedMo>ZG;m');
                  END IF;
                END
                \$\$;

                -- Grant privileges (quote database name)
                DO \$\$
                BEGIN
                  EXECUTE format('GRANT ALL PRIVILEGES ON DATABASE %I TO %I', 'prowlarr-log', 'prowlarr');
                  EXECUTE format('ALTER DATABASE %I OWNER TO %I', 'prowlarr-log', 'prowlarr');
                END
                \$\$;
              EOSQL
              echo "Database prowlarr-log created successfully"

          env:
            - name: PGHOST
              value: postgresql.postgresql
            - name: PGPORT
              value: "5432"
            - name: PGUSER
              value: postgres
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  key: adminPassword
                  name: postgresql-password
          image: pgvector/pgvector:pg17
          imagePullPolicy: IfNotPresent
          name: init-databases
      restartPolicy: OnFailure
