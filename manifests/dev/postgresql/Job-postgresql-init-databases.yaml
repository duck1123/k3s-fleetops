apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
  name: postgresql-init-databases
  namespace: postgresql
spec:
  template:
    spec:
      containers:
        - command:
            - sh
            - -c
            - |+
              set -e
              echo "Creating database prowlarr and user prowlarr..."
              psql -v ON_ERROR_STOP=1 <<-EOSQL
                -- Create database if it doesn't exist
                SELECT 'CREATE DATABASE prowlarr' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'prowlarr')\gexec

                -- Create user if it doesn't exist
                DO \$\$
                BEGIN
                  IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'prowlarr') THEN
                    EXECUTE format('CREATE USER %I WITH PASSWORD %L', 'prowlarr', 'omE.6H):+]qedMo>ZG;m');
                  END IF;
                END
                \$\$;

                -- Grant privileges
                GRANT ALL PRIVILEGES ON DATABASE prowlarr TO prowlarr;
                ALTER DATABASE prowlarr OWNER TO prowlarr;
              EOSQL
              echo "Database prowlarr created successfully"

          env:
            - name: PGHOST
              value: postgresql.postgresql
            - name: PGPORT
              value: "5432"
            - name: PGUSER
              value: admin
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  key: adminPassword
                  name: postgresql-password
          image: pgvector/pgvector:pg17
          imagePullPolicy: IfNotPresent
          name: init-databases
      restartPolicy: OnFailure
